# Clone riscv-gnu-toolchain once
RUN git clone https://github.com/riscv-collab/riscv-gnu-toolchain

WORKDIR $CODE_REPO/riscv-gnu-toolchain
# Init only specific submodules (e.g. gcc and binutils)
RUN git submodule update --init gcc

ENV RISCV_NEWLIB=${RISCV}/gnu_toolchain_newlib
RUN mkdir build-newlib && cd build-newlib \
  && GDB_NATIVE_FLAGS_EXTRA="--with-python=/usr --with-expat --with-system-readline" \
     GDB_TARGET_FLAGS_EXTRA="--with-python=/usr --with-expat --with-system-readline" \
     ../configure \
       --prefix=$RISCV_NEWLIB \
       --disable-linux \
       --enable-multilib \
       --with-arch=rv64gc \
       --with-abi=lp64d \
       --with-cmodel=medany \
       --with-languages=c,c++ \
  && make -j$(nproc)

# Build Linux (glibc) toolchain in build-linux/

ENV RISCV_LINUX=${RISCV}/gnu_toolchain_linux
RUN mkdir build-linux && cd build-linux \
  && GDB_NATIVE_FLAGS_EXTRA="--with-python=/usr --with-expat --with-system-readline" \
     GDB_TARGET_FLAGS_EXTRA="--with-python=/usr --with-expat --with-system-readline" \
     ../configure \
       --prefix=$RISCV_LINUX \
       --enable-linux \
       --enable-multilib \
       --enable-default-pie \
       --enable-strip \
       --with-arch=rv64gc \
       --with-abi=lp64d \
       --with-cmodel=medany \
       --with-languages=c,c++ \
       --with-multilib-generator="rv64gc-lp64d;rv32gc-ilp32d" \
  && make -j$(nproc) linux

WORKDIR $CODE_REPO

ENV PATH="$RISCV_LINUX/bin:$RISCV_NEWLIB/bin:\
$RISCV_PK/riscv64-unknown-elf/bin:$RISCV_PK/riscv64-unknown-linux-gnu/bin:\
$RISCV_ISA_SIM/bin:\
$RISCV_QEMU/bin:\
$HOME/.local/bin:$PATH"

